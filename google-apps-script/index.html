<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Pacientes - Casos Complejos</title>
    
    <?!= include('style'); ?>

</head>

<body class="<?!= userRol; ?>">

    <div class="modal-backdrop" id="modal-aviso">
        <div class="modal-content">
            <h2 id="titulo-modal-aviso">Aviso</h2>
            <p id="texto-modal-aviso">Mensaje de aviso</p>
            <div class="modal-botones-container">
                <button type="button" id="btn-modal-aviso-aceptar" class="boton-cancelar">Volver</button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="modal-cambiar-pass">
        <div class="modal-content">
            <h2>Cambio de Contrase√±a Obligatorio</h2>
            <p>Detectamos que est√°s usando una contrase√±a temporal. Por favor, crea una nueva contrase√±a.</p>
            <form id="form-cambiar-pass">
                <div class="form-group">
                    <label for="nueva-contrasena">Nueva Contrase√±a</label>
                    <input type="password" id="nueva-contrasena" name="nueva-contrasena" required>
                </div>
                <div class="form-group">
                    <label for="nueva-contrasena2">Confirmar Nueva Contrase√±a</label>
                    <input type="password" id="nueva-contrasena2" name="nueva-contrasena2" required>
                </div>
                <button type="submit">Guardar Nueva Contrase√±a</button>
                <div id="alerta-cambiar-pass" class="alerta" style="display: none;"></div>
            </form>
        </div>
    </div>

    <div class="modal-backdrop" id="modal-confirmar-edicion">
        <div class="modal-content">
            <h2>Confirmar Cambios</h2>
            <p>¬øEst√° seguro de que desea sobrescribir los datos de este paciente? Esta acci√≥n no se puede deshacer.</p>
            <div class="modal-botones-container">
                <button type="button" id="btn-confirmar-edicion-cancelar" class="boton-cancelar">Cancelar</button>
                <button type="button" id="btn-confirmar-edicion-aceptar" class="boton-aceptar">Aceptar</button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="modal-confirmar-eliminar">
        <div class="modal-content">
            <h2 id="titulo-modal-eliminar">Confirmar Acci√≥n</h2>
            <p id="texto-modal-eliminar">¬øEst√° seguro de que desea realizar esta acci√≥n?</p>
            <div class="modal-botones-container">
                <button type="button" id="btn-confirmar-eliminar-cancelar" class="boton-cancelar">Cancelar</button>
                <button type="button" id="btn-confirmar-eliminar-aceptar" class="boton-aceptar">Aceptar</button>
            </div>
        </div>
    </div>

    <div id="navbar">
        <h1>Gesti√≥n de Pacientes - Casos Complejos</h1>
        <div id="navbar-controls">
            <div id="theme-switcher">
                <button class="theme-btn" id="theme-corporate" data-theme="theme-corporate" title="Tema Corporativo (Azul)"></button>
                <button class="theme-btn" id="theme-minimalist" data-theme="theme-minimalist" title="Tema Minimalista (Verde)"></button>
                <button class="theme-btn" id="theme-dark" data-theme="theme-dark" title="Tema Oscuro"></button>
            </div>
            <div style="display:inline-flex;align-items:center;gap:2px;">
                <button id="navbar-user-btn" title="Usuario" tabindex="0" aria-label="Usuario">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="#1976d2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="8" r="4" />
                        <path d="M4 20c0-4 4-6 8-6s8 2 8 6" />
                    </svg>
                </button>
                
                <span id="navbar-user" style="font-weight:500;min-width:60px;"><?!= userName; ?></span>
                
                <button id="btn-logout-icon" title="Cerrar sesi√≥n" tabindex="0" aria-label="Cerrar sesi√≥n">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#e53935" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" y1="12" x2="9" y2="12" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div id="app-container">
        <div class="container" id="app-main-container">
            
            <details class="panel" id="panel-busqueda-avanzada">
                <summary><h4><span role="img" aria-label="Avanzado">üîç</span> B√∫squeda Avanzada</h4></summary>
                <div class="panel-content">
                    <div class="busqueda-avanzada-container">
                        <div class="busqueda-avanzada-filtros">
                            <form id="form-busqueda-avanzada">
                                <div class="form-group">
                                    <label for="adv-afiliado">Afiliado</label>
                                    <input type="text" id="adv-afiliado" name="afiliado" placeholder="(Cualquiera)" autocomplete="off" maxlength="100">
                                    <small class="tooltip-text">Puede buscar por apellido completo o DNI. Ejemplo: 'Martinez' o '12345678'</small>
                                </div>
                                <div class="form-group">
                                    <label for="adv-localidad">Localidad</label>
                                    <input type="text" id="adv-localidad" name="localidad" list="localidades-list" placeholder="(Cualquiera)" autocomplete="off" maxlength="100">
                                    <datalist id="localidades-list"></datalist>
                                    <small class="tooltip-text">Filtra pacientes por localidad de residencia</small>
                                </div>
                                <div class="form-group">
                                    <label for="adv-condicion">Condici√≥n</label>
                                    <select id="adv-condicion" name="condicion" class="select-sin-flecha">
                                        <option value="">(Cualquiera)</option>
                                        <option value="RESIDENTE">RESIDENTE</option>
                                        <option value="DERIVADO">DERIVADO</option>
                                        <option value="TRANSITO">TRANSITO</option>
                                    </select>
                                    <small class="tooltip-text">Seleccione la condici√≥n del paciente</small>
                                </div>
                                <div class="form-group">
                                    <label for="adv-tipo-afiliado">Tipo de Afiliado</label>
                                    <select id="adv-tipo-afiliado" name="tipo_afiliado" class="select-sin-flecha">
                                        <option value="">(Cualquiera)</option>
                                        <option value="Titular">Titular</option>
                                        <option value="Adherente">Adherente</option>
                                    </select>
                                    <small class="tooltip-text">Seleccione si el paciente es Titular o Adherente</small>
                                </div>
                                <div class="form-group">
                                    <label for="adv-prestador">Prestador</label>
                                    <input type="text" id="adv-prestador" name="prestador" list="prestadores-list" placeholder="(Cualquiera)" autocomplete="off" maxlength="100">
                                    <datalist id="prestadores-list"></datalist>
                                    <small class="tooltip-text">Filtra por el efector donde se realiz√≥ la prestaci√≥n</small>
                                </div>
                                <div class="form-group">
                                    <label for="adv-anio">A√±o de Prestaci√≥n</label>
                                    <input type="number" id="adv-anio" name="anio" list="anios-list" placeholder="(Cualquiera)" min="2000" max="2030" autocomplete="off">
                                    <datalist id="anios-list"></datalist>
                                    <small class="tooltip-text">Filtra por el a√±o en que se realiz√≥ la prestaci√≥n</small>
                                </div>
                                <div class="form-actions">
                                    <button type="reset" id="btn-limpiar-busqueda-avanzada" class="btn-secondary">Limpiar Filtros</button>
                                    <button type="submit" id="btn-busqueda-avanzada" class="btn-primary">Buscar</button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="busqueda-avanzada-resultados">
                            <div id="listado-resultados-avanzada"></div>
                        </div>
                    </div>
                </div>
            </details>

            <div class="panel" id="panel-busqueda">
                <div class="auditor-col" id="auditor-col-left">
                    <h2>Buscar Paciente</h2>
                    <div id="search-form">
                        <div class="form-group search-inline">
                            <label for="search-query">Buscar</label>
                            <input type="text" id="search-query" name="search-query" placeholder="Buscar por DNI o Apellido y Nombre...">
                            <button id="btn-buscar" type="button" title="Ejecutar b√∫squeda">
                                <span role="img" aria-label="Buscar">üîé</span>
                            </button>
                            <button id="btn-limpiar-busqueda" type="button" title="Limpiar b√∫squeda">
                                <span role="img" aria-label="Limpiar">üßπ</span>
                            </button>
                        </div>
                    </div>
                    <div id="info-busqueda-dni">Si busca por DNI, haga clic en el bot√≥n <b>Buscar</b> (lupa) o presione <b>Enter</b> luego de escribir o pegar el documento completo.</div>
                    
                    <div id="listado-resultados"></div>
                    <div id="info-paciente"></div>
                </div>
                
                <div class="auditor-col" id="auditor-col-right">
                    <div id="lista-prestaciones"></div>
                </div>
            </div>

            <div class="panel" id="panel-carga">
                <h2>Cargar/Editar Datos</h2>
                <details class="sub-details">
                    <summary><h4>Cargar Nuevo Paciente</h4></summary>
                    <div class="sub-details-content">
                        <form id="form-nuevo-paciente">
                            <div class="form-group">
                                <label for="new-dni">DNI</label>
                                <input type="text" id="new-dni" name="dni" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label for="new-nombre">Apellido y Nombre</label>
                                <input type="text" id="new-nombre" name="nombre" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label for="new-sexo">Sexo</label>
                                <select id="new-sexo" name="sexo" autocomplete="off">
                                    <option value="" selected disabled>Seleccione sexo</option>
                                    <option value="Femenino">Femenino</option>
                                    <option value="Masculino">Masculino</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Fecha de Nacimiento</label>
                                <div class="date-manual-inputs" id="new-fecha-nacimiento-inputs">
                                    <input type="number" id="new-fecha-dia" name="fecha_dia" min="1" max="31" placeholder="D√≠a" autocomplete="off" style="width: 60px; display: inline-block; margin-right: 4px;">
                                    <input type="number" id="new-fecha-mes" name="fecha_mes" min="1" max="12" placeholder="Mes" autocomplete="off" style="width: 60px; display: inline-block; margin-right: 4px;">
                                    <input type="number" id="new-fecha-anio" name="fecha_anio" min="1920" max="2100" placeholder="A√±o" autocomplete="off" style="width: 80px; display: inline-block;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="new-condicion">Condici√≥n</label>
                                <select id="new-condicion" name="condicion" autocomplete="off">
                                    <option value="" selected disabled>Seleccione condici√≥n</option>
                                    <option value="RESIDENTE">RESIDENTE</option>
                                    <option value="DERIVADO">DERIVADO</option>
                                    <option value="TRANSITO">TRANSITO</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="new-telefono">Tel√©fono</label>
                                <input type="text" id="new-telefono" name="telefono" placeholder="" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label for="new-direccion">Direcci√≥n</label>
                                <input type="text" id="new-direccion" name="direccion" placeholder="" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label for="new-localidad">Localidad</label>
                                <input type="text" id="new-localidad" name="localidad" list="localidades-list" placeholder="" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label for="new-tipo-afiliado">Tipo de Afiliado</label>
                                <select id="new-tipo-afiliado" name="tipo_afiliado" autocomplete="off">
                                    <option value="" selected disabled>Seleccione tipo de afiliado</option>
                                    <option value="Titular">Titular</option>
                                    <option value="Adherente">Adherente</option>
                                </select>
                            </div>
                            <div class="form-group" id="grupo-parentesco-nuevo">
                                <label for="new-vinculo-titular">Parentesco</label>
                                <select id="new-vinculo-titular" name="vinculo_titular" autocomplete="off">
                                    <option value="" selected disabled>Seleccione parentesco</option>
                                    <option value="Hijo/a">Hijo/a</option>
                                    <option value="Nieto/a">Nieto/a</option>
                                    <option value="C√≥nyuge">C√≥nyuge</option>
                                    <option value="Esposo/a">Esposo/a</option>
                                    <option value="Otro">Otro (especificar)</option>
                                </select>
                                <input type="text" id="new-vinculo-otro" name="vinculo_titular_otro" placeholder="Especificar parentesco" style="display:none; margin-top:8px;" autocomplete="off" />
                            </div>
                            <div class="form-group" id="grupo-titular-nombre-nuevo">
                                <label for="new-titular-nombre">Nombre y Apellido Titular</label>
                                <input type="text" id="new-titular-nombre" name="titular_nombre" placeholder="Apellido y Nombre del titular" autocomplete="off">
                            </div>
                            <div class="form-group" id="grupo-titular-dni-nuevo">
                                <label for="new-titular-dni">DNI Titular</label>
                                <input type="text" id="new-titular-dni" name="titular_dni" placeholder="DNI del afiliado titular" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label for="new-observaciones">Observaciones</label>
                                <textarea id="new-observaciones" name="observaciones" rows="3" placeholder="Observaciones adicionales" autocomplete="off"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Archivos Adjuntos</label>
                                <p style="font-size: 0.9em; color: #666; margin: 4px 0;">
                                    Los archivos se pueden subir directamente a la carpeta de Google Drive del paciente despu√©s de crearlo. 
                                    El link a la carpeta aparecer√° en la ficha del paciente.
                                </p>
                            </div>
                            <button type="submit" id="btn-guardar-paciente">Guardar Paciente</button>
                            <div id="alerta-paciente" class="alerta"></div>
                        </form>
                    </div>
                </details>
                <details class="sub-details">
                    <summary><h4>Cargar Nueva Prestaci√≥n</h4></summary>
                    <div class="sub-details-content">
                        <form id="form-nueva-prestacion">
                            <div class="form-group">
                                <label for="prest-dni">DNI del Paciente</label>
                                <input type="text" id="prest-dni" name="prest-dni" required>
                            </div>
                            <div class="form-group">
                                <label>Fecha</label>
                                <div class="date-picker-container">
                                    <div class="date-manual-inputs" id="prest-fecha-inputs">
                                        <input type="number" id="prest-fecha-dia" name="prest_fecha_dia" min="1" max="31" placeholder="D√≠a" required autocomplete="off" style="width: 60px; display: inline-block; margin-right: 4px;">
                                        <input type="number" id="prest-fecha-mes" name="prest_fecha_mes" min="1" max="12" placeholder="Mes" required autocomplete="off" style="width: 60px; display: inline-block; margin-right: 4px;">
                                        <input type="number" id="prest-fecha-anio" name="prest_fecha_anio" min="1920" max="2100" placeholder="A√±o" required autocomplete="off" style="width: 80px; display: inline-block; margin-right: 0;">
                                        <button type="button" id="btn-calendar-picker" class="btn-calendar-icon" title="Seleccionar fecha" style="position:absolute; right:6px; top:50%; transform:translateY(-50%); background:transparent; border:none; cursor:pointer; padding:0;">
                                            üìÖ
                                        </button>
                                    </div>
                                    <div id="calendar-dropdown" class="calendar-dropdown" style="display: none;">
                                        <div class="calendar-header">
                                            <button type="button" class="calendar-nav" id="calendar-prev-month">&lt;</button>
                                            <span id="calendar-month-year"></span>
                                            <button type="button" class="calendar-nav" id="calendar-next-month">&gt;</button>
                                        </div>
                                        <div class="calendar-weekdays">
                                            <span>Do</span><span>Lu</span><span>Ma</span><span>Mi</span><span>Ju</span><span>Vi</span><span>Sa</span>
                                        </div>
                                        <div id="calendar-days" class="calendar-days"></div>
                                        <div class="calendar-footer">
                                            <button type="button" id="btn-today" class="btn-today">Hoy</button>
                                            <button type="button" id="btn-close-calendar" class="btn-close-calendar">Cerrar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="prest-prestador">Prestador</label>
                                <div class="combo-prestador" style="position:relative;">
                                    <input type="text" id="prest-prestador" name="prest-prestador" autocomplete="off" class="combo-prestador-input">
                                    <button type="button" tabindex="-1" class="combo-prestador-btn" aria-label="Mostrar opciones" style="position:absolute; right:6px; top:50%; transform:translateY(-50%); background:transparent; border:none; cursor:pointer; padding:0;">
                                        <svg width="18" height="18" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z" fill="#666"/></svg>
                                    </button>
                                    <ul class="combo-prestador-list" style="display:none; position:absolute; left:0; right:0; top:110%; z-index:10; background:#fff; border:1px solid #ccc; border-radius:0 0 8px 8px; max-height:180px; overflow-y:auto; box-shadow:0 2px 8px rgba(0,0,0,0.08); margin:0; padding:0; list-style:none;"></ul>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Prestaciones</label>
                                <div id="prestaciones-container">
                                    <div class="prestacion-input-group">
                                        <input type="text" name="prestacion[]" class="prestacion-input" placeholder="Ingrese prestaci√≥n">
                                        <button type="button" class="btn-remove-prestacion" title="Quitar">&times;</button>
                                    </div>
                                </div>
                                <button type="button" id="btn-anadir-prestacion" class="btn-add-linea">+ A√±adir prestaci√≥n</button>
                            </div>
                            <button type="submit" id="btn-guardar-prestacion">Guardar Prestaci√≥n</button>
                            <div id="alerta-prestacion" class="alerta" style="display: none;"></div>
                        </form>
                    </div>
                </details>
                <details class="sub-details" id="panel-editar-paciente">
                    <summary><h4>Editar Paciente</h4></summary>
                    <div class="sub-details-content">
                        <div id="editar-busqueda-container">
                            <div class="editar-busqueda-row">
                                <input type="text" id="input-buscar-editar" name="input-buscar-editar" placeholder="Buscar por DNI o Apellido y Nombre..." />
                                <button id="btn-limpiar-busqueda-editar" type="button" title="Limpiar b√∫squeda">
                                    <span role="img" aria-label="Limpiar">üßπ</span>
                                </button>
                            </div>
                            <div id="info-busqueda-dni-editar">Si busca por DNI, debe presionar <b>Enter</b> luego de escribir o pegar el n√∫mero completo.</div>
                            <ul id="listado-pacientes-editar" class="listado-pacientes"></ul>
                            <div id="form-editar-paciente-container"></div>
                            <template id="tpl-edit-fecha-nacimiento-dropdowns">
                                <div class="date-dropdowns" id="edit-fecha-nacimiento-dropdowns">
                                    <select id="edit-fecha-dia" name="fecha_dia" class="date-select-day" required>
                                        <option value="" selected disabled hidden>D√≠a</option>
                                    </select>
                                    <select id="edit-fecha-mes" name="fecha_mes" class="date-select-month" required>
                                        <option value="" selected disabled hidden>Mes</option>
                                    </select>
                                    <select id="edit-fecha-anio" name="fecha_anio" class="date-select-year" required>
                                        <option value="" selected disabled hidden>A√±o</option>
                                    </select>
                                </div>
                            </template>
                        </div>
                    </div>
                </details>
            </div>

            <details id="details-admin">
                <summary>
                    <h3>‚öôÔ∏è Administraci√≥n</h3>
                </summary>
                <div class="details-content">
                    <h2>Administraci√≥n del Sistema</h2>
                    
                    <p>Los c√≥digos de registro fijos para nuevos usuarios son:</p>
                    <div class="code-display-container">
                        <div class="code-display-item">
                            <strong>ADMINISTRATIVO:</strong>
                            <span>ADMIN123</span>
                        </div>
                        <div class="code-display-item">
                            <strong>AUDITOR:</strong>
                            <span>AUDITOR123</span>
                        </div>
                    </div>
                    <small>Guarde y comparta estos c√≥digos de forma segura.</small>

                    <div id="panel-admin-usuarios">
                        <h3>Gestionar Usuarios</h3>
                        <div id="lista-usuarios-admin"></div>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <datalist id="localidades-list"></datalist>

    <script>
        // --- DEPURACI√ìN: Ver qu√© clase tiene el body ---
        console.log('Clase del body:', document.body.className);
        console.log('userRol recibido:', '<?!= userRol; ?>');
        console.log('¬øEs administrativo?', document.body.classList.contains('rol-administrativo'));
        console.log('¬øEs auditor?', document.body.classList.contains('rol-auditor'));
        
        // --- L√≥gica del Tema ---
        (function() {
            const savedTheme = localStorage.getItem('appTheme') || 'theme-corporate';
            const rolClass = document.body.className;
            document.body.className = savedTheme + ' ' + rolClass;
        })();

        document.getElementById('theme-switcher').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const theme = e.target.dataset.theme;
                const rolClass = document.body.className.split(' ').find(c => c.startsWith('rol-'));
                document.body.className = theme + ' ' + rolClass;
                localStorage.setItem('appTheme', theme);
            }
        });
        
        // --- L√≥gica de Paneles seg√∫n ROL ---
        document.addEventListener('DOMContentLoaded', function() {
            const esAdmin = document.body.classList.contains('rol-administrativo');
            
            console.log('DOMContentLoaded - ¬øEs admin?', esAdmin);
            console.log('Usuario es ' + (esAdmin ? 'ADMIN' : 'AUDITOR') + ' - El CSS controla la visibilidad');
        });

        // --- Logout ---
        document.getElementById('btn-logout-icon').addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            console.log('Cerrando sesi√≥n...');
            
            google.script.run
                .withSuccessHandler(function(url) {
                    console.log('Sesi√≥n cerrada, redirigiendo a:', url);
                    window.location.href = url;
                })
                .withFailureHandler(function(err) {
                    console.error('Error al cerrar sesi√≥n:', err);
                    alert('Error al cerrar sesi√≥n: ' + err.message);
                    btn.disabled = false;
                })
                .cerrarSesion();
        });

        // --- B√∫squeda de Paciente ---
        
        // B√∫squeda autom√°tica mientras se escribe (debounce de 500ms para reducir carga)
        let searchTimeout;
        let ultimaBusqueda = '';
        
        document.getElementById('search-query').addEventListener('input', function() {
            const query = this.value.trim();
            
            clearTimeout(searchTimeout);
            
            // Limpiar resultados si hay menos de 3 caracteres
            if (query.length < 3) {
                document.getElementById('listado-resultados').innerHTML = '';
                return;
            }
            
            // No buscar si es la misma consulta
            if (query === ultimaBusqueda) return;
            
            // Esperar 500ms antes de buscar (optimizado para GAS)
            searchTimeout = setTimeout(function() {
                ultimaBusqueda = query;
                document.getElementById('listado-resultados').innerHTML = '<span class="btn-spinner"></span> Buscando...';
                
                google.script.run
                    .withSuccessHandler(function(resultados) {
                        const listado = document.getElementById('listado-resultados');
                        
                        if (!resultados || resultados.length === 0) {
                            listado.innerHTML = '<p style="color:#888;font-style:italic;">No se encontraron resultados</p>';
                            return;
                        }
                        
                        let html = '<ul class="listado-pacientes">';
                        resultados.forEach(function(pac) {
                            html += `<li><button type="button" onclick="seleccionarPaciente('${pac.dni}')">${pac.dni} - ${pac.nombre}</button></li>`;
                        });
                        html += '</ul>';
                        listado.innerHTML = html;
                    })
                    .withFailureHandler(function(err) {
                        document.getElementById('listado-resultados').innerHTML = '<p style="color:red;">Error: ' + err.message + '</p>';
                    })
                    .buscarPacientesPorFragmento(query);
            }, 300);
        });
        
        // Funci√≥n para seleccionar un paciente de la lista
        window.seleccionarPaciente = function(dni) {
            document.getElementById('info-paciente').innerHTML = '<span class="btn-spinner"></span> Cargando paciente...';
            document.getElementById('listado-resultados').innerHTML = '';
            
            google.script.run
                .withSuccessHandler(function(paciente) {
                    if (!paciente) {
                        document.getElementById('info-paciente').innerHTML = '<p style="color:red;">Paciente no encontrado.</p>';
                        return;
                    }
                    
                    // Formatear valores
                    const nombreTitle = paciente.nombre || '(Sin nombre)';
                    const sexoText = paciente.sexo || '(Sin registrar)';
                    const fechaNacText = paciente.fecha_nacimiento || '(Sin registrar)';
                    const edadText = paciente.edad || '(Sin registrar)';
                    const condicionText = paciente.condicion || '(Sin registrar)';
                    const telefonoText = paciente.telefono || '(Sin registrar)';
                    const direccionText = paciente.direccion || '(Sin registrar)';
                    const localidadText = paciente.localidad || '(Sin registrar)';
                    const tipoAfiliadoText = paciente.tipo_afiliado || '(Sin registrar)';
                    const vinculoText = paciente.vinculo_titular || '(Sin registrar)';
                    const observacionesText = paciente.observaciones || '(Sin observaciones)';
                    
                    const titularNombreTitle = paciente.titular_nombre || '';
                    const formatDNI = function(dni) {
                        if (!dni) return '';
                        return dni.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    };
                    const titularText = titularNombreTitle ? titularNombreTitle + ' (' + formatDNI(paciente.titular_dni) + ')' : '';
                    
                    const esTitular = paciente.tipo_afiliado && paciente.tipo_afiliado.toUpperCase() === 'TITULAR';
                    const mostrarTitular = !esTitular && titularText;
                    
                    // Link a carpeta de Drive
                    const fichaHtml = paciente.carpeta_drive_id 
                        ? '<a href="https://drive.google.com/drive/folders/' + paciente.carpeta_drive_id + '" target="_blank" class="ver-ficha-link">Ver documentos en Drive</a>'
                        : '<span style="opacity:0.5;">(Sin carpeta Drive)</span>';
                    
                    // Bot√≥n eliminar solo para administrativos
                    const userRolClass = document.body.className;
                    const botonEliminarPaciente = userRolClass.includes('rol-administrativo') 
                        ? '<button class="icon-btn-delete-paciente" id="btn-eliminar-paciente" title="Eliminar paciente" aria-label="Eliminar paciente"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="#e53935" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:block;"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>'
                        : '';
                    
                    let html = '<div class="patient-card">';
                    html += '<div class="patient-card-header">';
                    html += '<div class="patient-card-title">';
                    html += '<div class="patient-name">' + nombreTitle + '</div>';
                    html += '<div class="patient-dni">' + formatDNI(paciente.dni) + '</div>';
                    html += '</div>';
                    html += '<div class="patient-card-logo-container">';
                    html += '<img src="https://www.iapos.gob.ar/sites/default/files/logo_0.png" alt="Logo IAPOS" class="patient-card-logo" draggable="false" onerror="this.style.display=\'none\'" />';
                    html += '</div></div>';
                    html += '<hr class="patient-card-header-separator" />';
                    html += '<div class="patient-card-grid-body">';
                    html += '<div class="grid-item"><span class="label">Sexo:</span><span class="value">' + sexoText + '</span></div>';
                    html += '<div class="grid-item"><span class="label">Fecha de Nacimiento:</span><span class="value">' + fechaNacText + '</span></div>';
                    html += '<div class="grid-item"><span class="label">Edad:</span><span class="value">' + edadText + '</span></div>';
                    html += '<div class="grid-item"><span class="label">Condici√≥n:</span><span class="value">' + condicionText + '</span></div>';
                    html += '<div class="grid-item"><span class="label">Tel√©fono:</span><span class="value">' + telefonoText + '</span></div>';
                    html += '<div class="grid-item"><span class="label">Direcci√≥n:</span><span class="value">' + direccionText + '</span></div>';
                    html += '<div class="grid-item"><span class="label">Localidad:</span><span class="value">' + localidadText + '</span></div>';
                    html += '<div class="grid-item"><span class="label">Tipo de Afiliado:</span><span class="value">' + tipoAfiliadoText + '</span></div>';
                    if (!esTitular) {
                        html += '<div class="grid-item"><span class="label">Parentesco:</span><span class="value">' + vinculoText + '</span></div>';
                    }
                    if (mostrarTitular) {
                        html += '<div class="grid-item"><span class="label">Titular:</span><span class="value">' + titularText + '</span></div>';
                    }
                    html += '</div>';
                    html += '<div class="patient-card-footer patient-card-footer-actions">';
                    html += '<div class="grid-item-fullwidth divider-top">';
                    html += '<span class="label">Observaciones:</span>';
                    html += '<span class="value">' + observacionesText + '</span>';
                    html += '</div>';
                    html += '<div class="footer-actions-row">';
                    html += '<div class="footer-link" id="ficha-documentos-container">' + fichaHtml + '</div>';
                    html += '<div class="footer-print-delete">';
                    html += '<button class="icon-btn-print-ficha" id="btn-imprimir-ficha" title="Imprimir ficha" aria-label="Imprimir ficha"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="#1976d2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:block;"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg></button>';
                    html += botonEliminarPaciente;
                    html += '</div></div></div></div>';
                    
                    document.getElementById('info-paciente').innerHTML = html;
                    
                    // Vincular bot√≥n imprimir
                    const btnImprimir = document.getElementById('btn-imprimir-ficha');
                    if (btnImprimir) {
                        btnImprimir.addEventListener('click', function() {
                            window.print();
                        });
                    }
                    
                    // Vincular bot√≥n eliminar (solo administrativos)
                    if (userRolClass.includes('rol-administrativo')) {
                        const btnEliminar = document.getElementById('btn-eliminar-paciente');
                        if (btnEliminar) {
                            btnEliminar.addEventListener('click', function() {
                                if (confirm('¬øSeguro que desea eliminar al paciente ' + paciente.nombre + '? Esta acci√≥n borrar√° todo su historial y no se puede deshacer.')) {
                                    document.getElementById('info-paciente').innerHTML = '<span class="btn-spinner"></span> Eliminando paciente...';
                                    google.script.run
                                        .withSuccessHandler(function(resultado) {
                                            alert(resultado.message);
                                            document.getElementById('info-paciente').innerHTML = '<p style="color:green;">' + resultado.message + '</p>';
                                        })
                                        .withFailureHandler(function(err) {
                                            alert('Error: ' + err.message);
                                            document.getElementById('info-paciente').innerHTML = '<p style="color:red;">Error: ' + err.message + '</p>';
                                        })
                                        .eliminarPaciente(paciente.dni);
                                }
                            });
                        }
                    }
                    
                    // Mostrar prestaciones en la columna derecha
                    mostrarPrestaciones(paciente.prestaciones, paciente.dni);
                })
                .withFailureHandler(function(err) {
                    document.getElementById('info-paciente').innerHTML = '<p style="color:red;">' + err.message + '</p>';
                })
                .buscarPacientePorDNI(dni);
        };
        
        // Funci√≥n para mostrar prestaciones
        function mostrarPrestaciones(prestaciones, pacienteDni) {
            const listaPrestacionesDiv = document.getElementById('lista-prestaciones');
            if (!listaPrestacionesDiv) return;
            
            if (!prestaciones || prestaciones.length === 0) {
                listaPrestacionesDiv.innerHTML = '<p style="opacity:0.6;">(Sin prestaciones registradas)</p>';
                return;
            }
            
            const userRolClass = document.body.className;
            const esAdmin = userRolClass.includes('rol-administrativo');
            
            let html = '<h3>Historial de Prestaciones</h3>';
            html += '<table class="prestaciones-table">';
            html += '<thead><tr><th>Fecha</th><th>Prestador</th><th>Prestaci√≥n</th>';
            if (esAdmin) html += '<th>Acci√≥n</th>';
            html += '</tr></thead><tbody>';
            
            prestaciones.forEach(function(prest) {
                html += '<tr>';
                html += '<td>' + (prest.fecha || '') + '</td>';
                html += '<td>' + (prest.prestador || '') + '</td>';
                html += '<td>' + (prest.prestacion || '') + '</td>';
                if (esAdmin) {
                    html += '<td><button class="btn-delete-prestacion" data-id="' + prest.id + '" title="Eliminar prestaci√≥n">üóëÔ∏è</button></td>';
                }
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            listaPrestacionesDiv.innerHTML = html;
            
            // Vincular botones de eliminar prestaci√≥n
            if (esAdmin) {
                const botonesEliminar = document.querySelectorAll('.btn-delete-prestacion');
                botonesEliminar.forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        const prestacionId = this.getAttribute('data-id');
                        if (confirm('¬øEst√° seguro de que desea eliminar esta prestaci√≥n?')) {
                            google.script.run
                                .withSuccessHandler(function(resultado) {
                                    alert(resultado.message);
                                    // Recargar paciente para actualizar la lista
                                    seleccionarPaciente(pacienteDni);
                                })
                                .withFailureHandler(function(err) {
                                    alert('Error: ' + err.message);
                                })
                                .eliminarPrestacion(prestacionId);
                        }
                    });
                });
            }
        }
        
        // B√∫squeda al presionar Enter o hacer clic en la lupa
        document.getElementById('btn-buscar').addEventListener('click', function() {
            var query = document.getElementById('search-query').value.trim();
            if (!query) return;
            
            // Si es un DNI completo (solo n√∫meros), buscar directamente
            if (/^\d+$/.test(query)) {
                seleccionarPaciente(query);
            }
        });
        
        // Buscar al presionar Enter
        document.getElementById('search-query').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const query = this.value.trim();
                if (query && /^\d+$/.test(query)) {
                    seleccionarPaciente(query);
                }
            }
        });
        
        // Limpiar b√∫squeda
        document.getElementById('btn-limpiar-busqueda').addEventListener('click', function() {
            document.getElementById('search-query').value = '';
            document.getElementById('listado-resultados').innerHTML = '';
            document.getElementById('info-paciente').innerHTML = '';
            document.getElementById('lista-prestaciones').innerHTML = '';
        });
        
        // --- FORMULARIO NUEVO PACIENTE ---
        const formNuevoPaciente = document.getElementById('form-nuevo-paciente');
        if (formNuevoPaciente) {
            // Mostrar/ocultar campos de titular seg√∫n tipo de afiliado
            const tipoAfiliadoSelect = document.getElementById('new-tipo-afiliado');
            const grupoParentesco = document.getElementById('grupo-parentesco-nuevo');
            const grupoTitularNombre = document.getElementById('grupo-titular-nombre-nuevo');
            const grupoTitularDni = document.getElementById('grupo-titular-dni-nuevo');
            
            // Funci√≥n para actualizar visibilidad
            function actualizarCamposTitular() {
                if (!tipoAfiliadoSelect) return;
                const esTitular = tipoAfiliadoSelect.value === 'Titular';
                const esAdherente = tipoAfiliadoSelect.value === 'Adherente';
                
                if (esTitular) {
                    grupoParentesco.style.display = 'none';
                    grupoTitularNombre.style.display = 'none';
                    grupoTitularDni.style.display = 'none';
                    // Limpiar valores cuando se ocultan
                    document.getElementById('new-vinculo-titular').value = '';
                    document.getElementById('new-titular-nombre').value = '';
                    document.getElementById('new-titular-dni').value = '';
                } else if (esAdherente) {
                    grupoParentesco.style.display = 'block';
                    grupoTitularNombre.style.display = 'block';
                    grupoTitularDni.style.display = 'block';
                } else {
                    // Sin selecci√≥n, ocultar todo
                    grupoParentesco.style.display = 'none';
                    grupoTitularNombre.style.display = 'none';
                    grupoTitularDni.style.display = 'none';
                }
            }
            
            // Ejecutar al cargar (estado inicial)
            actualizarCamposTitular();
            
            // Agregar listener para cambios
            if (tipoAfiliadoSelect) {
                tipoAfiliadoSelect.addEventListener('change', actualizarCamposTitular);
            }
            
            // Manejar "Otro" en parentesco
            const vinculoSelect = document.getElementById('new-vinculo-titular');
            const vinculoOtro = document.getElementById('new-vinculo-otro');
            if (vinculoSelect && vinculoOtro) {
                vinculoSelect.addEventListener('change', function() {
                    if (this.value === 'Otro') {
                        vinculoOtro.style.display = 'block';
                    } else {
                        vinculoOtro.style.display = 'none';
                        vinculoOtro.value = '';
                    }
                });
            }
            
            // Manejar el env√≠o del formulario
            formNuevoPaciente.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const tipoAfiliado = document.getElementById('new-tipo-afiliado').value;
                const dia = document.getElementById('new-fecha-dia').value;
                const mes = document.getElementById('new-fecha-mes').value;
                const anio = document.getElementById('new-fecha-anio').value;
                
                // Construir objeto de datos
                const formData = {
                    dni: document.getElementById('new-dni').value.trim(),
                    nombre: document.getElementById('new-nombre').value.trim(),
                    sexo: document.getElementById('new-sexo').value,
                    fecha_nacimiento: dia && mes && anio ? dia + '/' + mes + '/' + anio : '',
                    condicion: document.getElementById('new-condicion').value,
                    telefono: document.getElementById('new-telefono').value.trim(),
                    direccion: document.getElementById('new-direccion').value.trim(),
                    localidad: document.getElementById('new-localidad').value.trim(),
                    tipo_afiliado: tipoAfiliado,
                    vinculo_titular: '',
                    titular_nombre: '',
                    titular_dni: '',
                    observaciones: document.getElementById('new-observaciones').value.trim()
                };
                
                // Solo incluir datos de titular si es ADHERENTE
                if (tipoAfiliado === 'Adherente') {
                    const vinculoSelect = document.getElementById('new-vinculo-titular');
                    const vinculoOtroInput = document.getElementById('new-vinculo-otro');
                    
                    // Si seleccion√≥ "Otro", usar el texto personalizado
                    if (vinculoSelect.value === 'Otro' && vinculoOtroInput.value.trim()) {
                        formData.vinculo_titular = vinculoOtroInput.value.trim();
                    } else {
                        formData.vinculo_titular = vinculoSelect.value;
                    }
                    
                    formData.titular_nombre = document.getElementById('new-titular-nombre').value.trim();
                    formData.titular_dni = document.getElementById('new-titular-dni').value.trim();
                }
                
                // Validaci√≥n b√°sica
                if (!formData.dni || !formData.nombre) {
                    alert('DNI y Nombre son obligatorios');
                    return;
                }
                
                if (!formData.tipo_afiliado) {
                    alert('Debe seleccionar el Tipo de Afiliado');
                    return;
                }
                
                // Validar campos de adherente
                if (tipoAfiliado === 'Adherente') {
                    if (!formData.vinculo_titular) {
                        alert('Debe especificar el Parentesco para un Adherente');
                        return;
                    }
                    if (!formData.titular_nombre || !formData.titular_dni) {
                        alert('Debe completar Nombre y DNI del Titular para un Adherente');
                        return;
                    }
                }
                
                const alerta = document.getElementById('alerta-paciente');
                alerta.innerHTML = '<span class="btn-spinner"></span> Guardando paciente...';
                alerta.style.display = 'block';
                
                google.script.run
                    .withSuccessHandler(function(resultado) {
                        alert(resultado.message);
                        formNuevoPaciente.reset();
                        actualizarCamposTitular(); // Resetear visibilidad
                        alerta.style.display = 'none';
                    })
                    .withFailureHandler(function(err) {
                        alert('Error: ' + err.message);
                        alerta.innerHTML = '<p style="color:red;">Error: ' + err.message + '</p>';
                    })
                    .guardarNuevoPaciente_web(formData);
            });
        }
        
        // --- FORMULARIO NUEVA PRESTACI√ìN ---
        const formNuevaPrestacion = document.getElementById('form-nueva-prestacion');
        if (formNuevaPrestacion) {
            formNuevaPrestacion.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const dia = document.getElementById('prest-fecha-dia').value;
                const mes = document.getElementById('prest-fecha-mes').value;
                const anio = document.getElementById('prest-fecha-anio').value;
                
                const prestacionInputs = document.querySelectorAll('.prestacion-input');
                const prestaciones = [];
                prestacionInputs.forEach(function(input) {
                    if (input.value.trim()) {
                        prestaciones.push(input.value.trim());
                    }
                });
                
                const formData = {
                    paciente_dni: document.getElementById('prest-dni').value.trim(),
                    fecha: dia && mes && anio ? dia + '/' + mes + '/' + anio : '',
                    prestador: document.getElementById('prest-prestador').value.trim(),
                    prestaciones: prestaciones
                };
                
                if (!formData.paciente_dni || !formData.fecha || !formData.prestador || prestaciones.length === 0) {
                    alert('Todos los campos son obligatorios');
                    return;
                }
                
                const alerta = document.getElementById('alerta-prestacion');
                alerta.innerHTML = '<span class="btn-spinner"></span> Guardando prestaciones...';
                alerta.style.display = 'block';
                
                google.script.run
                    .withSuccessHandler(function(resultado) {
                        alert(resultado.message);
                        formNuevaPrestacion.reset();
                        alerta.style.display = 'none';
                    })
                    .withFailureHandler(function(err) {
                        alert('Error: ' + err.message);
                        alerta.innerHTML = '<p style="color:red;">Error: ' + err.message + '</p>';
                    })
                    .guardarNuevaPrestacion_web(formData);
            });
            
            // Bot√≥n para a√±adir m√°s l√≠neas de prestaci√≥n
            const btnAnadirPrestacion = document.getElementById('btn-anadir-prestacion');
            if (btnAnadirPrestacion) {
                btnAnadirPrestacion.addEventListener('click', function() {
                    const container = document.getElementById('prestaciones-container');
                    const newGroup = document.createElement('div');
                    newGroup.className = 'prestacion-input-group';
                    newGroup.innerHTML = '<input type="text" name="prestacion[]" class="prestacion-input" placeholder="Ingrese prestaci√≥n"><button type="button" class="btn-remove-prestacion" title="Quitar">&times;</button>';
                    container.appendChild(newGroup);
                    
                    // Vincular bot√≥n de quitar
                    newGroup.querySelector('.btn-remove-prestacion').addEventListener('click', function() {
                        newGroup.remove();
                    });
                });
            }
            
            // Vincular botones de quitar existentes
            document.querySelectorAll('.btn-remove-prestacion').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    this.parentElement.remove();
                });
            });
        }
    </script>
</body>
</html>
